********** 13 install ***********

# Install PostgreSQL13:

sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo dnf install -y postgresql13-server

mkdir -p /pgdata/13/main
sudo chown postgres:postgres /pgdata/13/main

vi /usr/lib/systemd/system/postgresql-13.service

systemctl daemon-reload

/usr/pgsql-13/bin/postgresql-13-setup  initdb postgresql-13

sudo systemctl enable postgresql-13
sudo systemctl start postgresql-13

*********** 16 install ***********

# Install PostgreSQL16:
sudo dnf install -y postgresql16-server

mkdir -p /pgdata/16/main
sudo chown postgres:postgres /pgdata/16/main

vi /usr/lib/systemd/system/postgresql-16.service

systemctl daemon-reload

/usr/pgsql-16/bin/postgresql-16-setup  initdb postgresql-16

sudo systemctl enable postgresql-16
sudo systemctl start postgresql-16

*************************** UPGRADE ADIMLARI ***************************

[postgres@pgnode ~]$ /usr/pgsql-16/bin/pg_upgrade \

-b /usr/pgsql-13/bin \
-B /usr/pgsql-16/bin \
-d /pgdata/13/main \
-D /pgdata/16/main \
--check

Performing Consistency Checks
-----------------------------
Checking cluster versions                                     ok
Checking database user is the install user                    ok
Checking database connection settings                         ok
Checking for prepared transactions                            ok
Checking for system-defined composite types in user tables    ok
Checking for reg* data types in user tables                   ok
Checking for contrib/isn with bigint-passing mismatch         ok
Checking for incompatible "aclitem" data type in user tables  ok
Checking for user-defined encoding conversions                ok
Checking for user-defined postfix operators                   ok
Checking for incompatible polymorphic functions               ok
Checking for presence of required libraries                   ok
Checking database user is the install user                    ok
Checking for prepared transactions                            ok
Checking for new cluster tablespace directories               ok

*Clusters are compatible*


---------------------------------

[postgres@pgnode ~]$ /usr/pgsql-16/bin/pg_upgrade -b /usr/pgsql-13/bin -B /usr/pgsql-16/bin -d /pgdata/13/main -D /pgdata/16/main
Performing Consistency Checks
-----------------------------
Checking cluster versions                                     ok
Checking database user is the install user                    ok
Checking database connection settings                         ok
Checking for prepared transactions                            ok
Checking for system-defined composite types in user tables    ok
Checking for reg* data types in user tables                   ok
Checking for contrib/isn with bigint-passing mismatch         ok
Checking for incompatible "aclitem" data type in user tables  ok
Checking for user-defined encoding conversions                ok
Checking for user-defined postfix operators                   ok
Checking for incompatible polymorphic functions               ok
Creating dump of global objects                               ok
Creating dump of database schemas
                                                              ok
Checking for presence of required libraries                   ok
Checking database user is the install user                    ok
Checking for prepared transactions                            ok
Checking for new cluster tablespace directories               ok

If pg_upgrade fails after this point, you must re-initdb the
new cluster before continuing.

Performing Upgrade
------------------
Setting locale and encoding for new cluster                   ok
Analyzing all rows in the new cluster                         ok
Freezing all rows in the new cluster                          ok
Deleting files from new pg_xact                               ok
Copying old pg_xact to new server                             ok
Setting oldest XID for new cluster                            ok
Setting next transaction ID and epoch for new cluster         ok
Deleting files from new pg_multixact/offsets                  ok
Copying old pg_multixact/offsets to new server                ok
Deleting files from new pg_multixact/members                  ok
Copying old pg_multixact/members to new server                ok
Setting next multixact ID and offset for new cluster          ok
Resetting WAL archives                                        ok
Setting frozenxid and minmxid counters in new cluster         ok
Restoring global objects in the new cluster                   ok
Restoring database schemas in the new cluster
                                                              ok
Copying user relation files
                                                              ok
Setting next OID for new cluster                              ok
Sync data directory to disk                                   ok
Creating script to delete old cluster                         ok
Checking for extension updates                                ok

Upgrade Complete
----------------
Optimizer statistics are not transferred by pg_upgrade.
Once you start the new server, consider running:
    /usr/pgsql-16/bin/vacuumdb --all --analyze-in-stages
Running this script will delete the old cluster's data files:
    ./delete_old_cluster.sh


--------------------------------------------------------------

vi /pgdata/16/main/postgresql.conf
port: 5433 ( 5432 olarak değiştiririz.)

vi /pgdata/13/main/postgresql.conf
port: 5432 ( 5433 olarak değiştiririz.)

---------------------------------------------------------------

systemctl start postgresql-16-service

---------------------------------------------------------------

su - postgres
psql
13 versiyonda kurduğumuz dbleri 16'da görmemiz lazım.

**** 13 versiyonda postgres ****

[postgres@pgnode ~]$ psql
psql (16.8, server 13.20)
Type "help" for help.

postgres=# select version();
                                                 version
----------------------------------------------------------------------------------------------------------
 PostgreSQL 13.20 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-23), 64-bit
(1 row)

postgres=#
postgres=#
postgres=# create database kerem
postgres-# ;
CREATE DATABASE
postgres=#
postgres=#
postgres=# create user kerem with password 'kerem';
CREATE ROLE
postgres=#
postgres=#
postgres=# alter database kerem owner to 'kerem';
ERROR:  syntax error at or near "'kerem'"
LINE 1: alter database kerem owner to 'kerem';
                                      ^
postgres=# alter database kerem owner to "kerem";
ALTER DATABASE
postgres=#
postgres=#
postgres=# \l
                                                       List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | ICU Locale | ICU Rules |   Access privileges
-----------+----------+----------+-----------------+-------------+-------------+------------+-----------+-----------------------
 kerem     | kerem    | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 postgres  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 template0 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres
 template1 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres
(4 rows)

postgres=# \q



****** 16 versiyonda postgres ******

[postgres@pgnode 13]$ psql
psql (16.8)
Type "help" for help.

postgres=#
postgres=#
postgres=# select version()İ
postgres-# ;
                                                    İ
---------------------------------------------------------------------------------------------------------
 PostgreSQL 16.8 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-23), 64-bit
(1 row)

postgres=# \l
                                                       List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | ICU Locale | ICU Rules |   Access privileges
-----------+----------+----------+-----------------+-------------+-------------+------------+-----------+-----------------------
 kerem     | kerem    | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 postgres  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 template0 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres
 template1 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | postgres=CTc/postgres+
           |          |          |                 |             |             |            |           | =c/postgres
(4 rows)

postgres=# \du
                             List of roles
 Role name |                         Attributes
-----------+------------------------------------------------------------
 kerem     |
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS

postgres=#


***************** Yeni Cluster için analyze ve vacuumdb çalıştırırız ***********************

[postgres@pgnode ~] cd /var/lib/pgsql
[postgres@pgnode ~]$ /usr/pgsql-16/bin/vacuumdb --all --analyze-in-stages
vacuumdb: processing database "kerem": Generating minimal optimizer statistics (1 target)
vacuumdb: processing database "postgres": Generating minimal optimizer statistics (1 target)
vacuumdb: processing database "template1": Generating minimal optimizer statistics (1 target)
vacuumdb: processing database "kerem": Generating medium optimizer statistics (10 targets)
vacuumdb: processing database "postgres": Generating medium optimizer statistics (10 targets)
vacuumdb: processing database "template1": Generating medium optimizer statistics (10 targets)
vacuumdb: processing database "kerem": Generating default (full) optimizer statistics
vacuumdb: processing database "postgres": Generating default (full) optimizer statistics
vacuumdb: processing database "template1": Generating default (full) optimizer statistics

----------------------------------------------------------------
[root@pgnode bin]# yum list --installed| grep postgresql
pcp-pmda-postgresql.x86_64                         5.3.7-22.0.3.el8_10                                         @ol8_appstream
postgresql13.x86_64                                13.20-1PGDG.rhel8                                           @pgdg13
postgresql13-libs.x86_64                           13.20-1PGDG.rhel8                                           @pgdg13
postgresql13-server.x86_64                         13.20-1PGDG.rhel8                                           @pgdg13
postgresql16.x86_64                                16.8-1PGDG.rhel8                                            @pgdg16
postgresql16-libs.x86_64                           16.8-1PGDG.rhel8                                            @pgdg16
postgresql16-server.x86_64                         16.8-1PGDG.rhel8                                            @pgdg16

----------------------------------------------------------------

[root@pgnode bin]# sudo yum remove postgresql13*
Dependencies resolved.
==============================================================================================================================================================================================================
 Package                                                 Architecture                               Version                                                 Repository                                   Size
==============================================================================================================================================================================================================
Removing:
 postgresql13                                            x86_64                                     13.20-1PGDG.rhel8                                       @pgdg13                                     7.6 M
 postgresql13-libs                                       x86_64                                     13.20-1PGDG.rhel8                                       @pgdg13                                     1.6 M
 postgresql13-server                                     x86_64                                     13.20-1PGDG.rhel8                                       @pgdg13                                      22 M

Transaction Summary
==============================================================================================================================================================================================================
Remove  3 Packages

Freed space: 31 M
Is this ok [y/N]: y
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                                                                                                                                                      1/1
  Running scriptlet: postgresql13-server-13.20-1PGDG.rhel8.x86_64                                                                                                                                         1/1
  Running scriptlet: postgresql13-server-13.20-1PGDG.rhel8.x86_64                                                                                                                                         1/3
  Erasing          : postgresql13-server-13.20-1PGDG.rhel8.x86_64                                                                                                                                         1/3
  Running scriptlet: postgresql13-server-13.20-1PGDG.rhel8.x86_64                                                                                                                                         1/3
  Erasing          : postgresql13-13.20-1PGDG.rhel8.x86_64                                                                                                                                                2/3
  Running scriptlet: postgresql13-13.20-1PGDG.rhel8.x86_64                                                                                                                                                2/3
  Erasing          : postgresql13-libs-13.20-1PGDG.rhel8.x86_64                                                                                                                                           3/3
  Running scriptlet: postgresql13-libs-13.20-1PGDG.rhel8.x86_64                                                                                                                                           3/3
  Verifying        : postgresql13-13.20-1PGDG.rhel8.x86_64                                                                                                                                                1/3
  Verifying        : postgresql13-libs-13.20-1PGDG.rhel8.x86_64                                                                                                                                           2/3
  Verifying        : postgresql13-server-13.20-1PGDG.rhel8.x86_64                                                                                                                                         3/3

Removed:
  postgresql13-13.20-1PGDG.rhel8.x86_64                           postgresql13-libs-13.20-1PGDG.rhel8.x86_64                           postgresql13-server-13.20-1PGDG.rhel8.x86_64

Complete!


------------------------------------------------------------------------

[root@pgnode bin]# cd /var/lib/pgsql/
[root@pgnode pgsql]# rm -rf 13
[root@pgnode pgsql]# su - postgres
[postgres@pgnode ~]$ pwd
/var/lib/pgsql
[postgres@pgnode ~]$ ll
total 4
drwx------ 4 postgres postgres 51 Mar 22 02:54 16
-rwx------ 1 postgres postgres 36 Mar 22 03:23 delete_old_cluster.sh
[postgres@pgnode ~]$ ./delete_old_cluster.sh
[postgres@pgnode ~]$